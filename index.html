<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Pathfinder</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/toolbar.css">
    <link rel="stylesheet" href="css/canvas.css">
    <link rel="stylesheet" href="css/sidebar.css">
</head>
<body>
    <div id="app">
        <!-- Top Toolbar -->
        <header class="toolbar">
            <div class="toolbar-left">
                <div class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    <span>Map Pathfinder</span>
                </div>
            </div>
            <div class="toolbar-center">
                <div class="mode-toggle">
                    <button class="mode-btn active" data-mode="edit">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Edit Mode
                    </button>
                    <button class="mode-btn" data-mode="view">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        View Mode
                    </button>
                </div>
            </div>
            <div class="toolbar-right">
                <button class="toolbar-btn" id="importBtn" title="Import maps">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="exportBtn" title="Export maps">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" id="menuBtn" title="Menu">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="19" cy="12" r="1"/>
                        <circle cx="5" cy="12" r="1"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Left Sidebar -->
            <aside class="sidebar sidebar-left">
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <h3>Maps</h3>
                        <button class="sidebar-btn" id="addMapBtn" title="Add new map">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="map-tree" id="mapTree">
                        <div class="empty-state">
                            <p>No maps yet</p>
                            <button class="btn btn-primary" id="createFirstMapBtn">Create Map</button>
                        </div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <h3>Properties</h3>
                    </div>
                    <div class="properties-panel" id="propertiesPanel">
                        <div class="empty-state">
                            <p>Select an item to view properties</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Canvas Area -->
            <div class="canvas-container" id="canvasContainer">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <!-- Map image will be inserted here -->
                    <img id="mapImage" class="map-image" alt="Map" draggable="false">
                    <!-- Canvas overlay for terrain painting -->
                    <canvas id="terrainCanvas" class="terrain-canvas"></canvas>
                    <!-- SVG overlay for waypoints, edges, paths -->
                    <svg id="svgOverlay" class="svg-overlay"></svg>
                </div>
                
                <!-- Canvas Tools (Edit Mode) -->
                <div class="canvas-tools" id="canvasTools">
                    <button class="tool-btn active" data-tool="select" title="Select (V)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                        </svg>
                    </button>
                    <button class="tool-btn" data-tool="waypoint" title="Add Waypoint (W)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <circle cx="12" cy="12" r="8" stroke-dasharray="4 2"/>
                        </svg>
                    </button>
                    <button class="tool-btn" data-tool="edge" title="Add Edge (E)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="19" x2="19" y2="5"/>
                            <circle cx="5" cy="19" r="2"/>
                            <circle cx="19" cy="5" r="2"/>
                        </svg>
                    </button>
                    <button class="tool-btn" data-tool="paint" title="Paint Terrain (T)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 11H5a4 4 0 0 0-4 4v1a1 1 0 0 0 1 1h20a1 1 0 0 0 1-1v-1a4 4 0 0 0-4-4z"/>
                            <path d="M12 11V3a2 2 0 0 1 4 0v2"/>
                        </svg>
                    </button>
                    <div class="tool-divider"></div>
                    <button class="tool-btn" data-tool="pan" title="Pan (Space+Drag)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 9l-3 3 3 3"/>
                            <path d="M9 5l3-3 3 3"/>
                            <path d="M15 19l-3 3-3-3"/>
                            <path d="M19 9l3 3-3 3"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <line x1="12" y1="2" x2="12" y2="22"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Terrain Palette (shown when paint tool active) -->
                <div class="terrain-palette hidden" id="terrainPalette">
                    <div class="terrain-palette-header">
                        <span>Terrain</span>
                        <label class="terrain-toggle">
                            <input type="checkbox" id="terrainVisibleToggle" checked>
                            <span>Show</span>
                        </label>
                    </div>
                    <div class="terrain-types" id="terrainTypes">
                        <!-- Terrain type buttons will be populated dynamically -->
                    </div>
                    <div class="brush-size">
                        <label>Brush: <span id="brushSizeValue">2</span></label>
                        <input type="range" id="brushSizeSlider" min="1" max="10" value="2">
                    </div>
                    <div class="terrain-actions">
                        <button class="btn btn-primary btn-sm" id="recalcAllCostsBtn">Recalc All Costs</button>
                        <button class="btn btn-secondary btn-sm" id="clearTerrainBtn">Clear Terrain</button>
                    </div>
                </div>

                <!-- View Mode Controls -->
                <div class="view-controls hidden" id="viewControls">
                    <div class="view-controls-hint">
                        Click waypoints to set route.<br>
                        <strong>Shift+click</strong> anywhere for custom start/end.
                    </div>
                    <div class="route-info" id="routeInfo">
                        <div class="route-card primary-route hidden" id="primaryRouteCard">
                            <div class="route-header">
                                <span class="route-label">Best Route</span>
                                <span class="route-cost" id="primaryRouteCost">--</span>
                            </div>
                        </div>
                        <div class="route-card alt-route hidden" id="altRouteCard">
                            <div class="route-header">
                                <span class="route-label">Alternative</span>
                                <span class="route-cost" id="altRouteCost">--</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="findRouteBtn" disabled>Find Route</button>
                    <button class="btn btn-secondary" id="clearRouteBtn">Clear</button>
                </div>

                <!-- Zoom Controls -->
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomInBtn" title="Zoom In">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="11" y1="8" x2="11" y2="14"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button class="zoom-btn" id="zoomFitBtn" title="Fit to View">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 3H5a2 2 0 0 0-2 2v3"/>
                            <path d="M21 8V5a2 2 0 0 0-2-2h-3"/>
                            <path d="M3 16v3a2 2 0 0 0 2 2h3"/>
                            <path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
                        </svg>
                    </button>
                </div>

                <!-- Empty State -->
                <div class="canvas-empty-state" id="canvasEmptyState">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    <h2>No Map Selected</h2>
                    <p>Create a new map or select one from the sidebar</p>
                    <button class="btn btn-primary" id="uploadMapBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload Map Image
                    </button>
                </div>
            </div>
        </main>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <span class="status-item" id="statusMode">Edit Mode</span>
                <span class="status-divider">|</span>
                <span class="status-item" id="statusTool">Select Tool</span>
            </div>
            <div class="status-right">
                <span class="status-item" id="statusWaypoints">Waypoints: 0</span>
                <span class="status-divider">|</span>
                <span class="status-item" id="statusEdges">Edges: 0</span>
                <span class="status-divider">|</span>
                <span class="status-item" id="statusSaved">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Saved
                </span>
            </div>
        </footer>
    </div>

    <!-- Hidden file input for map upload -->
    <input type="file" id="mapFileInput" accept="image/*" hidden>
    <input type="file" id="importFileInput" accept=".json" hidden>

    <!-- Modal for creating/editing maps -->
    <div class="modal hidden" id="mapModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="mapModalTitle">New Map</h2>
                <button class="modal-close" id="mapModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="mapNameInput">Map Name</label>
                    <input type="text" id="mapNameInput" placeholder="Enter map name...">
                </div>
                <div class="form-group">
                    <label>Map Image</label>
                    <div class="image-upload" id="imageUploadArea">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <p>Click or drag to upload image</p>
                        <input type="file" id="modalImageInput" accept="image/*" hidden>
                    </div>
                    <div class="image-preview hidden" id="imagePreviewArea">
                        <img id="imagePreview" alt="Preview">
                        <button class="btn btn-secondary btn-sm" id="changeImageBtn">Change Image</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="parentMapSelect">Parent Map (optional)</label>
                    <select id="parentMapSelect">
                        <option value="">None (top-level map)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="mapModalCancel">Cancel</button>
                <button class="btn btn-primary" id="mapModalSave">Create Map</button>
            </div>
        </div>
    </div>

    <!-- Import Confirmation Modal -->
    <div class="modal hidden" id="importModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Import Maps</h2>
                <button class="modal-close" id="importModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="importModalMessage">You have existing maps. How would you like to import?</p>
            </div>
            <div class="modal-footer import-modal-footer">
                <button class="btn btn-secondary" id="importCancelBtn">Cancel</button>
                <button class="btn btn-secondary" id="importReplaceBtn">Replace All</button>
                <button class="btn btn-primary" id="importMergeBtn">Merge</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu hidden" id="contextMenu">
        <button class="context-menu-item" data-action="rename">Rename</button>
        <button class="context-menu-item" data-action="delete">Delete</button>
        <div class="context-menu-divider"></div>
        <button class="context-menu-item" data-action="make-portal">Toggle Portal</button>
        <button class="context-menu-item" data-action="make-bezier">Convert to Curve</button>
    </div>

    <!-- Toast notification -->
    <div class="toast hidden" id="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Load app scripts as ES modules -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
